name: Build macOS Vertune

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-latest

    env:
      APP_NAME: Vertune

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew update
          brew install sdl2 glew freetype llvm

      - name: Build Vertune
        shell: bash
        run: |
          set -e
          mkdir -p build
          cd build

          LLVM_PREFIX=$(brew --prefix llvm)
          SDK_PATH=$(xcrun --sdk macosx --show-sdk-path)

          echo "Using LLVM from: $LLVM_PREFIX"
          echo "Using SDK: $SDK_PATH"

          # Find all .cpp files
          SRC_FILES=$(find ../src -name "*.cpp")

          clang++ $SRC_FILES \
            -std=c++20 -DRENDER_OPENGL -stdlib=libc++ -O2 \
            -I../external/include -I"$LLVM_PREFIX/include" \
            -L"$LLVM_PREFIX/lib" -L/opt/homebrew/lib \
            -lSDL2 -lGLEW -lfreetype -framework OpenGL -framework Cocoa \
            --sysroot "$SDK_PATH" \
            -o vertune

      - name: Create .app bundle
        shell: bash
        run: |
          mkdir -p dist/${APP_NAME}.app/Contents/MacOS
          mkdir -p dist/${APP_NAME}.app/Contents/Resources
          cp build/vertune dist/${APP_NAME}.app/Contents/MacOS/vertune
          cp assets.pak dist/${APP_NAME}.app/Contents/Resources/ || true
          echo "Basic macOS app created"

      - name: Zip the app
        shell: bash
        run: |
          cd dist
          zip -r vertune.zip vertune.app
          cd ..

      - name: List files before upload
        run: ls -R dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vertune-macos-dist
          path: dist/vertune.zip
